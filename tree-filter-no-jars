#!/bin/bash

. $(dirname $0)/binary-repo-lib.sh

modfiles=$(git diff-tree -r --name-status $GIT_COMMIT | awk '$1 != "D" { print $2 }')
user=user
password=password

printInfo() {
  echo ""
  echo "Arguments $@"
  echo "GIT_DIR = $GIT_DIR"
  echo "GIT_WORK_TREE = $GIT_WORK_TREE"
  echo "GIT_INDEX_TREE = $GIT_INDEX_FILE"
  echo "GIT_COMMIT = $GIT_COMMIT"
  echo "Changes"
  echo "-----------"
  echo "$modfiles"
  echo "-----------"
}

fixWhitespace() {
  local file=$1
  #echo "Fixing whitespace for $(pwd)/$1"
  #echo ""
  fromdos $file
  cat $file | sed 's/[ \t]*$//' > $file
}

#Modify the modified files...
for file in $modfiles; do
  if test -f $file; then
    ext=${file#*.}
    if [[ "$ext" == "jar" ]]; then
      echo ""
      p=$GIT_WORK_TREE #$(pwd)
      pushJarFile "$p/$file" "$p" "$user" "$password"
      echo "Removing $file from $GIT_COMMIT..."
      echo ""
      rm -f $file
    elif [[ "$ext" == "scala" ]] || [[ "$ext" == "java" ]]; then
      #fix whitespace and such
      fixWhitespace $GIT_WORK_TREE/$file
    fi
  fi
done

exit 0
