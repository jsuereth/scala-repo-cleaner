#!/bin/bash

modfiles=$(git diff-tree -r --name-status $GIT_COMMIT | awk '$1 != "R" { print $2 }')

printInfo() {
  echo ""
  echo "Arguments $@"
  echo "GIT_DIR = $GIT_DIR"
  echo "GIT_WORK_TREE = $GIT_WORK_TREE"
  echo "GIT_INDEX_TREE = $GIT_INDEX_FILE"
  echo "GIT_COMMIT = $GIT_COMMIT"
  echo "Changes"
  echo "-----------"
  echo "$modfiles"
  echo "-----------"
}

fixWhitespace() {
  local file=$1
  #echo "Fixing whitespace for $(pwd)/$1"
  #echo ""
  fromdos $file
  cat $file | sed 's/[ \t]*$//' > $file
}


pushjarfiles=""

#Modify the modified files...
for file in $modfiles; do
  if test -f $file; then
    ext=${file#*.}
    if [[ "$ext" == "jar" ]]; then
      pushjarfiles=true
    elif [[ "$ext" == "scala" ]] || [[ "$ext" == "java" ]]; then
      # TODO - fix whitespace and such
      fixWhitespace $GIT_WORK_TREE/$file
    fi
  fi
done

# Run jar removal fix
if test $pushjarfiles; then
  jars=$(find . -name "*.jar")
  pushscript=$(dirname $0)/push-binary-libs.sh
  # Push new jar files.
  $pushscript user password >/dev/null
  #echo "Removing Jar files."
  for file in $modfiles; do
    ext=${file#*.}
    if test "$ext" == "jar" && test -f $file; then
      rm $GIT_WORK_TREE/$file
    fi
  done
  # The generated "desired.sha1" files should automatically be added back to the tree....
fi
